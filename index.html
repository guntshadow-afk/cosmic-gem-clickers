/* main.js — Cosmic Clicker (All-features scaffold)
   Drop this file into your repo and wire it to your index.html.
   Uses mascot asset: /mnt/data/A_digital_illustration_in_pastel_colors_depicts_a_.png
*/

/* ----------------- CONFIG ----------------- */
const CONFIG = {
  SAVE_KEY: "cosmic_clicker_full_v1",
  LEADER_KEY: "cosmic_clicker_lb_v1",
  COST_GROWTH: 1.15,
  OFFLINE_MAX_HOURS: 24,
  MASCOT_ASSET: "/mnt/data/A_digital_illustration_in_pastel_colors_depicts_a_.png",
  AUTO_LB_INTERVAL_MS: 60_000
};

/* ----------------- UTILITIES ----------------- */
const fmt = (n) => {
  if (n === Infinity || Number.isNaN(n)) return "0";
  if (n < 1000) return Math.round(n * 100) / 100;
  const units = ["K", "M", "B", "T", "Qa", "Qi"];
  let u = -1;
  while (n >= 1000 && u < units.length - 1) {
    n /= 1000;
    u++;
  }
  return (Math.round(n * 100) / 100) + units[u];
};
const nowMs = () => Date.now();

/* ----------------- GAME STATE ----------------- */
class GameState {
  constructor() {
    // core resources
    this.ce = 0;
    this.owned = { cpc: {1:0,2:0,3:0}, cps: {1:0,2:0,3:0} };
    // prestige & meta
    this.stardust = 0;
    this.galactic = 0;
    this.universal = 0;
    // extras
    this.relics = []; // {id, tier, bonus}
    this.mascot = { level: 1, xp: 0, skills: {} };
    this.achievements = {};
    this.daily = { lastClaim: 0, streak: 0 };
    // bookkeeping
    this.lastSave = nowMs();
    this.createdAt = nowMs();
  }

  baseCPC(){
    let b = 1;
    b += this.owned.cpc[1] * 1;
    b += this.owned.cpc[2] * 10;
    b += this.owned.cpc[3] * 100;
    return b;
  }
  baseCPS(){
    let b = 0;
    b += this.owned.cps[1] * 1;
    b += this.owned.cps[2] * 10;
    b += this.owned.cps[3] * 100;
    return b;
  }
  prestigeMultiplier(){
    return 1 + this.stardust * 0.05 + this.galactic * 0.15 + this.universal * 0.5;
  }
  effectiveCPC(globalEventMult=1){
    return this.baseCPC() * this.prestigeMultiplier() * globalEventMult;
  }
  effectiveCPS(globalEventMult=1){
    return this.baseCPS() * this.prestigeMultiplier() * globalEventMult;
  }
}

/* ----------------- SHOP ----------------- */
const SHOP_DEFS = {
  cpc: {
    1: {name: "Focus Lens", base: 10, eff: 1},
    2: {name: "Quantum Tap", base: 100, eff: 10},
    3: {name: "Singularity Click", base: 1000, eff: 100}
  },
  cps: {
    1: {name: "Solar Panel", base: 50, eff: 1},
    2: {name: "Asteroid Miner", base: 500, eff: 10},
    3: {name: "Dyson Sphere", base: 5000, eff: 100}
  }
};

class Shop {
  constructor(state) { this.state = state; }
  getCost(type, tier){
    const def = SHOP_DEFS[type][tier];
    const cnt = this.state.owned[type][tier] || 0;
    return Math.ceil(def.base * Math.pow(CONFIG.COST_GROWTH, cnt));
  }
  buy(type, tier){
    const cost = this.getCost(type,tier);
    if (this.state.ce >= cost) {
      this.state.ce -= cost;
      this.state.owned[type][tier] = (this.state.owned[type][tier] || 0) + 1;
      UI.spawnFloat('-' + fmt(cost));
      Persistence.save();
      UI.updateAll();
      Achievements.checkAll();
      return true;
    } else {
      UI.showToast("Not enough CE");
      return false;
    }
  }
}

/* ----------------- EVENTS ----------------- */
class EventSystem {
  constructor(){ this.active = null; }
  maybeStart(){
    if (this.active) return;
    if (Math.random() < 0.06) {
      const mult = +(1.2 + Math.random()*4).toFixed(2);
      const dur = 30 + Math.floor(Math.random()*120);
      this.active = { mult, expiresAt: Date.now() + dur*1000 };
      UI.showToast("Cosmic Event x" + mult);
      setTimeout(()=> { this.active = null; }, dur*1000);
    }
  }
  getMult(){ return this.active ? this.active.mult : 1; }
}

/* ----------------- DAILY REWARD ----------------- */
class Daily {
  constructor(state){ this.state = state; }
  canClaim(){
    const today = Math.floor(Date.now()/86400000);
    return this.state.daily.lastClaim !== today;
  }
  claim(){
    if (!this.canClaim()) return { ok:false, msg:"Already claimed today" };
    const today = Math.floor(Date.now()/86400000);
    const yesterday = today - 1;
    if (this.state.daily.lastClaim === yesterday) this.state.daily.streak++;
    else this.state.daily.streak = 1;
    this.state.daily.lastClaim = today;
    const base = 1000;
    const reward = Math.floor(base * Math.max(1, this.state.daily.streak) * (1 + this.state.stardustBonus()));
    this.state.ce += reward;
    Persistence.save();
    return { ok:true, reward };
  }
  stardustBonus(){ return this.state ? (this.state.stardust * 0.05) : 0; }
}

/* ----------------- MASCOT ----------------- */
class Mascot {
  constructor(state){
    this.state = state;
    this.el = null;
  }
  initUI(imgSelector){
    this.el = document.querySelector(imgSelector);
    if (this.el) this.el.src = CONFIG.MASCOT_ASSET;
  }
  gainXP(x){
    this.state.mascot.xp += x;
    const needed = this.state.mascot.level * 100;
    if (this.state.mascot.xp >= needed){
      this.state.mascot.xp -= needed;
      this.state.mascot.level++;
      UI.spawnFloat("Mascot LV "+this.state.mascot.level);
    }
  }
}

/* ----------------- RELICS ----------------- */
class RelicSystem {
  constructor(state){ this.state = state; }
  tryDrop(){
    if (Math.random() < 0.02){
      const tiers = ["rare","epic","legendary","cosmic"];
      const tier = tiers[Math.floor(Math.random()*tiers.length)];
      const relic = { id: "r_"+Date.now(), tier, bonus: { ceMult: tier==="cosmic"?0.5: tier==="legendary"?0.25: tier==="epic"?0.12:0.04 } };
      this.state.relics.push(relic);
      UI.spawnFloat("Relic! " + tier);
      Persistence.save();
    }
  }
  // fusion stub
  fuse(aId,bId){
    // TODO: implement fusion probabilities & result
    UI.showToast("Relic fusion coming soon");
  }
}

/* ----------------- MINI-GAMES (stubs) ----------------- */
class MiniGames {
  static asteroidDodge(){ UI.showToast("Asteroid Dodge stub"); }
  static cosmicRhythm(){ UI.showToast("Cosmic Rhythm stub"); }
  static stargateChallenge(){ UI.showToast("Stargate Challenge stub"); }
  static galaxyMemory(){ UI.showToast("Galaxy Memory stub"); }
}

/* ----------------- LEADERBOARD ----------------- */
class Leaderboard {
  constructor(){
    this.key = CONFIG.LEADER_KEY;
    this.autoTimer = null;
  }
  getLocal(){
    try{ return JSON.parse(localStorage.getItem(this.key) || "[]"); }catch(e){ return []; }
  }
  saveLocal(arr){ localStorage.setItem(this.key, JSON.stringify(arr)); }
  submit(name){
    const arr = this.getLocal();
    arr.push({ name: name||"Anon", score: Math.floor(game.state.ce), ts: Date.now() });
    arr.sort((a,b)=>b.score-a.score);
    if (arr.length>100) arr.length = 100;
    this.saveLocal(arr);
    UI.showToast("Score submitted");
  }
  autoUpdateStart(){
    this.autoTimer = setInterval(()=> {
      const arr = this.getLocal();
      arr.push({ name: "You", score: Math.floor(game.state.ce), ts: Date.now() });
      arr.sort((a,b)=>b.score-a.score);
      if (arr.length>100) arr.length = 100;
      this.saveLocal(arr);
    }, CONFIG.AUTO_LB_INTERVAL_MS);
  }
  autoUpdateStop(){ if (this.autoTimer) clearInterval(this.autoTimer); }
}

/* ----------------- ACHIEVEMENTS ----------------- */
const ACH_DEFS = [
  {id:"first_click",name:"First Click",desc:"Make your first click",check: s=>s.ce>=1},
  {id:"collector_1k",name:"Collector 1k",desc:"Reach 1,000 CE",check: s=>s.ce>=1000},
  {id:"million",name:"Millionaire",desc:"Reach 1,000,000 CE",check: s=>s.ce>=1_000_000}
];
class Achievements {
  static checkAll(){
    ACH_DEFS.forEach(a=>{
      if (!game.state.achievements[a.id] && a.check(game.state)){
        game.state.achievements[a.id] = true;
        UI.spawnFloat("Achievement: "+a.name);
        Persistence.save();
      }
    });
  }
}

/* ----------------- PERSISTENCE ----------------- */
class Persistence {
  static save(){
    game.state.lastSave = nowMs();
    localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(game.state));
  }
  static load(){
    const raw = localStorage.getItem(CONFIG.SAVE_KEY);
    if (!raw) return false;
    try{
      const obj = JSON.parse(raw);
      // deep merge minimal
      Object.assign(game.state, obj);
      // offline calc
      const last = obj.lastSave || obj.createdAt || nowMs();
      const diffSec = Math.min((nowMs() - last)/1000, CONFIG.OFFLINE_MAX_HOURS*3600);
      const offlineGain = game.state.baseCPS ? game.state.baseCPS()* diffSec * game.state.prestigeMultiplier() : 0;
      game.state.ce += offlineGain;
      if (offlineGain > 0) UI.showToast("Offline +"+fmt(Math.floor(offlineGain)));
      return true;
    }catch(e){ console.warn("Load failed", e); return false; }
  }
  static clear(){
    localStorage.removeItem(CONFIG.SAVE_KEY);
    UI.showToast("Save cleared");
  }
}

/* ----------------- UI helpers ----------------- */
const UI = {
  spawnFloat(text){
    const container = document.getElementById("floatingContainer");
    if (!container) return;
    const el = document.createElement("div");
    el.className = "float";
    el.style.position = "absolute";
    el.style.left = Math.random()*60 + "%";
    el.style.top = "0px";
    el.style.fontWeight = "800";
    el.style.color = "#ffd";
    el.textContent = text;
    container.appendChild(el);
    setTimeout(()=> el.remove(), 900);
  },
  showToast(msg){
    console.log("TOAST:", msg);
    // lightweight: create small toast element
    const t = document.createElement("div");
    t.style.position = "fixed";
    t.style.right = "12px";
    t.style.top = "12px";
    t.style.background = "rgba(0,0,0,0.7)";
    t.style.color = "#fff";
    t.style.padding = "8px 12px";
    t.style.borderRadius = "8px";
    t.style.zIndex = 9999;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=> t.remove(), 1800);
  },
  updateAll(){
    // simple UI updates — expects elements with these ids in HTML
    const ceEl = document.getElementById("ceDisplay");
    if (ceEl) ceEl.textContent = fmt(Math.floor(game.state.ce));
    const cpc = document.getElementById("cpcDisplay");
    if (cpc) cpc.textContent = Math.round(game.state.effectiveCPC(game.events.getMult()));
    const cps = document.getElementById("cpsDisplay");
    if (cps) cps.textContent = Math.round(game.state.effectiveCPS(game.events.getMult()));
    const st = document.getElementById("stardust");
    if (st) st.textContent = game.state.stardust;
  }
};

/* ----------------- SOUND & HAPTICS ----------------- */
const Sound = {
  playClick(){
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = "sine"; o.frequency.value = 880;
      g.gain.value = 0.02;
      o.connect(g); g.connect(ctx.destination);
      o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.12);
      setTimeout(()=>{ o.stop(); ctx.close(); }, 160);
    }catch(e){}
  },
  // placeholders for music & SFX
};

/* ----------------- MAIN GAME CLASS ----------------- */
class Game {
  constructor(){
    this.state = new GameState();
    this.shop = new Shop(this.state);
    this.events = new EventSystem();
    this.daily = new Daily(this.state);
    this.mascot = new Mascot(this.state);
    this.relics = new RelicSystem(this.state);
    this.leader = new Leaderboard();
    this.tickRate = 100; // ms
    this._lastTick = nowMs();
    this.running = false;
  }

  init(){
    // UI wiring
    const clickBtn = document.getElementById("clickBtn");
    if (clickBtn) {
      clickBtn.addEventListener("click", (e) => {
        this.onClick(e);
      });
    }
    const saveBtn = document.getElementById("saveBtn");
    if (saveBtn) saveBtn.addEventListener("click", ()=>{ Persistence.save(); UI.showToast("Saved"); });
    const resetBtn = document.getElementById("resetBtn");
    if (resetBtn) resetBtn.addEventListener("click", ()=>{ if (confirm("Reset progress?")) { Persistence.clear(); location.reload(); }});
    const prestigeBtn = document.getElementById("prestigeBtn");
    if (prestigeBtn) prestigeBtn.addEventListener("click", ()=> this.doPrestige());
    const claimDailyButton = document.getElementById("claimDaily");
    if (claimDailyButton) claimDailyButton.addEventListener("click", ()=> this.claimDaily());
    const submitScore = document.getElementById("submitScore");
    if (submitScore) submitScore.addEventListener("click", ()=> { const n = prompt("Name (max 24)"); this.leader.submit(n && n.slice(0,24)); });

    // buy buttons in-shop dynamically rendered via renderShop hooks;
    // ensure mascot UI loads
    this.mascot.initUI("#mascotImg");

    // load save
    Persistence.load();

    // start leader auto-update
    this.leader.autoUpdateStart();

    // start main loop
    this.running = true;
    this._looper();
  }

  onClick(e){
    const gain = this.state.effectiveCPC(this.events.getMult());
    this.state.ce += gain;
    UI.spawnFloat("+"+fmt(Math.round(gain)));
    Sound.playClick();
    try { navigator.vibrate && navigator.vibrate(15); } catch(e){}
    this.mascot.gainXP(1);
    this.relics.tryDrop();
    Achievements.checkAll();
    UI.updateAll();
  }

  onTick(dt){
    // passive income
    const cps = this.state.effectiveCPS(this.events.getMult());
    this.state.ce += cps * (dt/1000);
    // try events occasionally
    if (Math.random() < 0.006) this.events.maybeStart();
    // autosave occasionally
    if (nowMs() - this.state.lastSave > 5000) Persistence.save();
    UI.updateAll();
  }

  _looper(){
    if (!this.running) return;
    const now = nowMs();
    const dt = now - this._lastTick;
    this._lastTick = now;
    this.onTick(dt);
    requestAnimationFrame(()=>this._looper());
  }

  doPrestige(){
    if (this.state.ce < 1_000_000) return UI.showToast("Need 1,000,000 CE to prestige");
    const earned = Math.floor(this.state.ce/1_000_000);
    this.state.stardust += earned;
    // auto-award galactic/universal thresholds
    const newGal = Math.floor(this.state.stardust/100);
    if (newGal > this.state.galactic) this.state.galactic = newGal;
    const newUni = Math.floor(this.state.stardust/1000);
    if (newUni > this.state.universal) this.state.universal = newUni;
    // reset core progress
    this.state.ce = 0;
    this.state.owned = { cpc:{1:0,2:0,3:0}, cps:{1:0,2:0,3:0} };
    Persistence.save();
    UI.showToast("Prestiged +"+earned+" SD");
  }

  claimDaily(){
    if (!this.daily.canClaim()) return UI.showToast("Daily already claimed");
    // reward calculation
    const today = Math.floor(Date.now()/86400000);
    const yesterday = today - 1;
    if (this.state.daily.lastClaim === yesterday) this.state.daily.streak++;
    else this.state.daily.streak = 1;
    this.state.daily.lastClaim = today;
    const base = 1000;
    const reward = Math.floor(base * Math.max(1,this.state.daily.streak) * (1 + 0.05*this.state.stardust));
    this.state.ce += reward;
    Persistence.save();
    UI.showToast("Daily +" + fmt(reward) + " (streak " + this.state.daily.streak + ")");
  }

  // Expandable: add more complex systems (guilds, trading, cloud save) here
}

/* ----------------- Bootstrap ----------------- */
const game = new Game();

// Quick UI: render a simple shop area (if shopList exists)
function attachShopUI(){
  const shopEl = document.getElementById("shopList");
  if (!shopEl) return;
  shopEl.innerHTML = "";
  ["cpc","cps"].forEach(type=>{
    Object.keys(SHOP_DEFS[type]).forEach(t=>{
      const def = SHOP_DEFS[type][t];
      const row = document.createElement("div");
      row.className = "flex justify-between items-center";
      const buyBtn = document.createElement("button");
      buyBtn.textContent = "Buy";
      buyBtn.className = "btn";
      buyBtn.onclick = ()=> { game.shop.buy(type, Number(t)); };
      row.innerHTML = `<div><b>${def.name}</b><div class="text-xs">${type.toUpperCase()} +${def.eff}</div></div>`;
      row.appendChild(buyBtn);
      shopEl.appendChild(row);
    });
  });
}

// Attach basic UI wiring when DOM ready
window.addEventListener("DOMContentLoaded", ()=>{
  attachShopUI();
  game.init();
  UI.updateAll();
  // attempt to register a service worker (if service-worker.js exists in repo)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').then(()=> console.log('SW registered')).catch(()=>console.log('SW reg failed'));
  }
});

/* ----------------- Notes & Next Steps -----------------
  - Many advanced features (guilds, P2P trading, cloud sync, full mini-games, relic fusion algorithms,
    multi-realm dynamic content, full audio mixing, anti-cheat) are included as TODO stubs.
  - To fully "add all features", implement these TODOs:
     * Expand MiniGames.* functions into real mini games UI + reward mechanics
     * Implement Relic.fuse with probabilistic outcomes & resource costs
     * Add Cloud Save via Firebase / Supabase for cross-device
     * Implement real online leaderboard with a hosted JSON endpoint
     * Add UI pages for Realms, Guilds, Market, Crafting, Story mode
     * Implement advanced automation tuning UI & bot rules
     * Implement achievement-specific rewards & titles
     * Flesh out Omni Prestige tier (endgame)
  - I can automatically generate service-worker.js, manifest.json, icons, and a zipped Android TWA or Electron package next.
----------------------------------------------- */
